function worker_func(){self.addEventListener("message",function(c){var d=c.data;switch(d.cmd){case"start":break;case"stop":this.postMessage({cmd:"stopped"}),self.close();break;case"convert":var b=d.data,b=_do_convert_yuv2rgb(b.chroma,b.y,b.u,b.v,b.w,b.h,b.stridey,b.strideu,b.stridev,b.bppy,b.bppu,b.bppv);this.postMessage({cmd:"converted",data:{image:b}},[b.buffer])}},0)}function _do_convert_yuv420(B,Q,V,F,D,H,I,M,T,K,S,A){for(var N,G,W,O,J,P=0,z=0,U=F>>1,L=U*D,x=0,q=0,j=0,E=0;E<L;E++){N=1.164*(B[x+(O=P<<1)]-16),G=Q[q+P]-128,W=V[j+P]-128,A[(J=E<<1)<<2]=N+1.596*W,A[1+(J<<2)]=N-0.813*W-0.391*G,A[2+(J<<2)]=N+2.018*G,A[3+(J<<2)]=255,N=1.164*(B[x+O+1]-16),A[1+J<<2]=N+1.596*W,A[1+(1+J<<2)]=N-0.813*W-0.391*G,A[2+(1+J<<2)]=N+2.018*G,A[3+(1+J<<2)]=255,++P===U&&(P=0,x+=H,q=(++z>>1)*I,j=(z>>1)*M)}}function _do_convert_yuv2rgb(y,p,w,b,z,f,g,k,v,j,q,x,m){switch(m=m||new Uint8ClampedArray(z*f*4),y){case 0:console.log("Chroma format not implemented yet",y,j,q,x);break;case 1:8!==j||8!==q||8!==x?console.log("Chroma format not implemented yet",y,j,q,x):_do_convert_yuv420(p,w,b,z,f,g,k,v,j,q,x,m);break;case 2:case 3:console.log("Chroma format not implemented yet",y,j,q,x);break;default:console.log("Unsupported chroma format",y,j,q,x)}return m}var worker_blob_url=null,WorkerConverter=function(){var a,c;this.player=new RawPlayer(deviceSdk.video265),this.callbacks=[],null===worker_blob_url&&(a=worker_func.toString(),c=(c=worker_func.name)||/^function\s+([\w\$]+)\s*\(/.exec(a)[1],c=new Blob(["(function() {\n",_do_convert_yuv420.toString()+";\n",_do_convert_yuv2rgb.toString()+";\n",a+";\n",c+"();\n","}).call(this);"],{type:"text/javascript"}),worker_blob_url=window.URL.createObjectURL(c));var b=this;this.worker=new Worker(worker_blob_url),this.worker.addEventListener("message",function(f){switch(f.data.cmd){case"converted":if(10<b.callbacks.length&&(console.log("callbacks ",b.callbacks.length),b.callbacks=b.callbacks.slice(b.callbacks.length-5)),0==b.callbacks.length){break}for(var g=0;g<b.callbacks.length-1;g++){var d=b.callbacks[0];b.callbacks=b.callbacks.splice(1),d(f.data.data.image)}break;case"stopped":b.callbacks=null,b=null}},!1),this.worker.postMessage({cmd:"start"})};WorkerConverter.prototype.destroy=function(){this.worker&&(this.worker.postMessage({cmd:"stop"}),this.worker=null)},WorkerConverter.prototype.convert=function(A,v,y,b,B,g,j,m,x,k,w,z){var z={cmd:"convert",data:{chroma:A,y:v,u:y,v:b,w:B,h:g,stridey:j,strideu:m,stridev:x,bppy:k,bppu:w,bppv:z}},q=this.player._get_img_data(B,g),f=this;this.callbacks.push(function(d){if(q.data.set){q.data.set(d)}else{for(var i=q.data,c=i.length,h=0;h<c;h++){i[h]=d[h]}}f.player._display_image(q)}),this.worker.postMessage(z,[v.buffer,y.buffer,b.buffer])};var RawPlayer=function(a){this.canvas=a,this.ctx=a.getContext("2d"),this.ratio=null,this.filters=!1,this._reset()};RawPlayer.prototype._reset=function(){this.start=null,this.frames=0,this.image_data=null,this.running=!1,this.queue=null,this.pending_image_data=null,this.queue=[]},RawPlayer.prototype._get_img_data=function(c,f){if(c!=this.canvas.width||f!=this.canvas.height||!this.image_data){this.canvas.width=c,this.canvas.height=f,this.image_data=this.ctx.createImageData(c,f);for(var b=this.image_data.data,d=0;d<c*f;d++){b[4*d+3]=255}}return this.image_data},RawPlayer.prototype._display_image=function(a){var b;return window.requestAnimationFrame?(this.pending_image_data=a,b=this,window.requestAnimationFrame(function(){b.pending_image_data&&(b.ctx.putImageData(b.pending_image_data,0,0),b.pending_image_data=null)})):this.ctx.putImageData(a,0,0),a},RawPlayer.prototype.stop=function(){this._reset()},RawPlayer.prototype.set_framerate_ratio=function(a){this.ratio=a},RawPlayer.prototype.disable_filters=function(a){this.filters=a};